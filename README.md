# 居住支援管理システム

社会福祉法人の居住支援サービスにおける利用者情報、相談履歴、支援計画を統合管理するWebアプリケーションです。

## 主な機能

### 1. 利用者情報ハブ機能
- 利用者名簿の一覧表示（100名以上対応）
- **【NEW】2026/01/17追加ー利用者ステータス管理機能:**
  - 利用者の状態を「利用中」「逝去」「解約」で管理
  - 一覧ページでのタブ切り替えによるフィルタリング（デフォルトは「利用中」のみ表示）
  - ステータス変更時の終了日（逝去日/解約日）記録機能
- 利用者基本情報の管理（氏名、住所、連絡先、物件情報等）
- 統合情報表示（基本情報、相談履歴、支援計画をタブ形式で表示）
- 新規利用者の追加・削除機能

### 2. 相談受付フォーム機能
- 契約の有無を問わない新規相談登録
- 匿名相談対応
- 詳細な相談内容入力（ADL/IADL、医療情報、収入情報等）
- 既存利用者への追加相談記録
- **【NEW】2026/01/18追加ー年代フラグ管理機能:**
  - 正確な生年月日が不明な場合でも、統計用に「30代」「40代」…「80代以上」を記録可能
  - **インテリジェント連動:** 生年月日を入力すると年代が自動算出され、手動選択は物理的にロック（Disabled）されます。データの矛盾をシステムレベルで防止します。

### 3. 相談履歴管理機能
- 全相談内容の一覧表示
- **進捗ステータス管理機能:**
  - 各相談記録に「進行中」「初回面談」「支援終了」などのステータスを設定可能
  - 一覧ページでステータスを直感的に変更できるドロップダウンリスト
  - ステータスごとの絞り込み（フィルタリング）機能
- **【NEW】視覚的ヒント表示:** 一覧画面に年齢（生年月日あり時）または年代（生年月日不明時）を表示し、スタッフの記憶想起をサポート。
- 検索・フィルタリング機能（キーワード、相談月、ステータス、電話番号、住所等）
- 相談詳細表示
- 匿名相談から契約後相談まで統一管理

### 4. 支援計画機能
- 住宅入居者支援計画書の作成・管理
- 更新履歴の自動保存
- 相談情報からの利用者登録機能
- 支援計画の検索・一覧表示

### 5. データ管理と出力機能
- 利用者名簿のExcel/CSVインポート
- 各種データのExcel/CSVエクスポート（個別相談票の `{{age_group}}` 出力に対応）
- 期間別相談実績レポート生成
- データ整合性チェック機能

### 6. データ分析ダッシュボード機能
- フロントページに設置された、事業活動を可視化するダッシュボード
- **相談ルート分析（円グラフ）:** どの経路からの相談が多いかを把握
- **相談者属性分析（棒グラフ）:** どのような課題を持つ相談者が多いかを把握
- **月別推移分析（複合グラフ）:** 活動量の推移を時系列で把握
- **【UPDATE】ハイブリッド年齢層集計 (2026/01/18):** 生年月日からの計算値と、手動選択された年代データを自動統合し、統計の欠落を解消。
- インタラクティブな期間フィルター（今月、先月、過去3ヶ月/6ヶ月）

## 技術スタック

- **フロントエンド**: Next.js 14.2.18 (App Router), TypeScript, React 18.3.1, Tailwind CSS 3.4.1
- **バックエンド/データベース**: Supabase (PostgreSQL 17系)
- **グラフ描画**: Chart.js, react-chartjs-2
- **日付処理**: date-fns
- **デプロイ**: Vercel
- **パッケージ管理**: pnpm

## 技術的な特記事項

本システムは、保守性と拡張性を高めるためにいくつかの重要な設計上の決定を行っています。

### 1. ビルド環境と環境の固定 (2026/02/01 更新)

本システムは、依存ライブラリ間の整合性と安定稼働のため、環境を厳密に固定しています。**これらから逸脱するとビルド崩壊を招くリスクが高い**ため、注意してください。

- **TypeScript: 5.5.4** (ESLint v7/v8との整合性のための固定)
- **ESLint: v8 世代**
- **TypeScript-ESLint: v7 世代**

#### 厳守事項
- **ESLint v9 の導入禁止:** `eslint.config.mjs` 等の Flat Config 形式を導入しないでください。
- **バージョン・ドリフトの防止:** `package.json` の TypeScript のバージョンを上げたり、`^` (キャレット) を付けたりしないでください。
- **コード作法:** `catch (e)` 構文などで変数を使用しない場合は `catch { ... }` と記述し、不要な `eslint-disable` コメントを排除してください。

### 2. Excelエクスポート機能の実装
`xlsx-populate`ライブラリを使用しており、以下の点に注意してください。
- **テンプレート依存:** `src/app/api/export/` 内の API Routes は、`public/` 内のExcelテンプレートに強く依存しています。
- **実装アプローチ:** 行削除APIが存在しないため、**「1件目のデータで6行目を上書きし、以降を追記＋スタイルコピー」**するという職人芸的なロジックを採用しています。
- **API Routesの採用:** Vercel本番環境でのファイルパス解決を安定させるため、Server Actions ではなく API Routes で実装されています。

### 3. データベース RPC (関数) の整合性
相談履歴一覧の取得には Supabase RPC (`get_consultations_with_next_action`) を使用しています。
- **制約:** RPCの戻り値の型・順序は、物理テーブル構造、および `src/types/consultation.ts` と **100% 一致している必要があります**。

## セットアップ

### 1. 依存関係のインストール
```bash
pnpm install
```

### 2. 環境変数の設定
`.env.local`ファイルを作成し、Supabaseの接続情報を設定してください。

### 3. ローカル開発環境の起動
**前提:** Supabase CLI, Dockerがインストールされていること。
```bash
npx supabase@latest start
pnpm dev
```

## データベース開発ルール

**Supabase管理画面のSQL Editorを直接編集することは原則禁止です。**
1. **マイグレーション作成:** `supabase migration new [name]`
2. **SQLの記述:** `supabase/migrations/` 内に定義。
3. **ローカル反映と型同期 (最重要):**
   ```bash
   npx supabase@latest db reset
   npx supabase@latest gen types typescript --local > src/types/database.ts
   ```
4. **本番反映:** `npx supabase@latest db push`

## データベース構造

### テーブル構成
- `users` - 利用者マスタ（status, end_date カラムによるライフサイクル管理）
- `consultations` - 相談テーブル（age_group カラムによる統計の正規化）
- `support_plans` - 支援計画テーブル
- `staff` - スタッフテーブル

### 主要な機能
- Row Level Security (RLS) による安全なデータアクセス
- UUID による主キー設定
- RPCによる高速なページネーションと検索ロジック

## 使用方法

### 利用者登録・編集
1. サイドバーの「新規利用者追加」をクリック、または一覧から「編集」
2. **ステータス管理:** 退去や逝去の際はステータスを変更し、終了日を記録。

### 相談受付・年代入力
1. ヘッダーの「新規相談」をクリック
2. **年代のヒント:** 生年月日がわかれば入力。わからなければ「年代」を選択。
3. 生年月日を入力すると年代は自動計算され、変更できなくなります。

### データ管理
1. 「データ管理」ページでエクスポートを実行。
2. 個別相談票に年代を出したい場合は、テンプレートに `{{age_group}}` を配置。

## 非機能要件
- **セキュリティ:** Supabase RLS による認可制御。
- **パフォーマンス:** 効率的なインデックスとRPCによる高速検索。
- **UI/UX:** ITに不慣れなスタッフでも迷わない直感的デザイン。

## ライセンス
このプロジェクトは社会福祉法人向けに開発されました。