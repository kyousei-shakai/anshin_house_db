# 居住支援管理システム

社会福祉法人の居住支援サービスにおける利用者情報、相談履歴、支援計画を統合管理するWebアプリケーションです。

## 主な機能

### 1. 利用者情報ハブ機能
- 利用者名簿の一覧表示（100名以上対応）
- 利用者基本情報の管理（氏名、住所、連絡先、物件情報等）
- 統合情報表示（基本情報、相談履歴、支援計画をタブ形式で表示）
- 新規利用者の追加・削除機能

### 2. 相談受付フォーム機能
- 契約の有無を問わない新規相談登録
- 匿名相談対応
- 詳細な相談内容入力（ADL/IADL、医療情報、収入情報等）
- 既存利用者への追加相談記録

### 3. 相談履歴管理機能
- 全相談内容の一覧表示
- **【NEW】2025/09/08追加ー進捗ステータス管理機能:**
  - 各相談記録に「進行中」「初回面談」「支援終了」などのステータスを設定可能
  - 一覧ページでステータスを直感的に変更できるドロップダウンリスト
  - ステータスごとの絞り込み（フィルタリング）機能
- 検索・フィルタリング機能（キーワード、相談月、ステータス等）
- 相談詳細表示
- 匿名相談から契約後相談まで統一管理

### 4. 支援計画機能
- 住宅入居者支援計画書の作成・管理
- 更新履歴の自動保存
- 相談情報からの利用者登録機能
- 支援計画の検索・一覧表示

### 5. データ管理と出力機能
- 利用者名簿のExcel/CSVインポート
- 各種データのExcel/CSVエクスポート
- 期間別相談実績レポート生成
- データ整合性チェック機能

### 6. データ分析ダッシュボード機能
- フロントページに設置された、事業活動を可視化するダッシュボード
- **相談ルート分析（円グラフ）:** どの経路からの相談が多いかを把握
- **相談者属性分析（棒グラフ）:** どのような課題を持つ相談者が多いかを把握
- **月別推移分析（複合グラフ）:** 活動量の推移を時系列で把握
- インタラクティブな期間フィルター（今月、先月、過去3ヶ月/6ヶ月

## 技術スタック

- **フロントエンド**: Next.js (App Router), TypeScript, React, Tailwind CSS
- **バックエンド/データベース**: Supabase (PostgreSQL)
- **グラフ描画**: Chart.js, react-chartjs-2
- **日付処理**: date-fns
- **デプロイ**: Vercel
- **パッケージ管理**: pnpm

## 技術的な特記事項

本システムは、保守性と拡張性を高めるためにいくつかの重要な設計上の決定を行っています。特に注意すべき点を以下に記載します。

### Excelエクスポート機能の実装について

本システムには、`xlsx-populate`ライブラリを使用した動的なExcelファイル生成機能（例: 月次報告書）が実装されています。この機能は、コードと外部ファイル（Excelテンプレート）が密接に連携するため、以下の点に注意してください。

1.  **テンプレートファイルへの強い依存:**
    *   `src/app/actions/export.ts` 内のサーバーアクションは、`public/`ディレクトリに配置された特定の名前・構造のExcelテンプレートファイル（例: `monthly_report_template.xlsx`）に強く依存しています。
    *   テンプレートの**シート名、行番号、セル番地**などを変更する場合は、必ず対応するサーバーアクション内のハードコードされた値も修正する必要があります。

2.  **ライブラリのAPI制約と実装アプローチ:**
    *   `xlsx-populate`には**行を削除するAPI (`row.delete()`) が存在しません。**
    *   そのため、動的に行を追加する処理は、「テンプレート行を後から削除する」方式ではなく、**「1件目のデータでテンプレート行を上書きし、2件目以降を追記していく」**というアプローチで実装されています。これはライブラリの制約に基づく意図的な設計です。
    *   同様に、セルのスタイルをコピーする際は、ライブラリの仕様に従い、コピーしたいスタイルプロパティ（`'bold'`, `'fontSize'`など）を明示的に指定する必要があります。

これらの背景を理解することで、将来の改修時に同じ問題に直面することを防ぎ、安全なメンテナンスを継続できます。


## セットアップ

### 1. 依存関係のインストール
```bash
pnpm install
```

### 2. 環境変数の設定
`.env.local`ファイルを作成し、Supabaseの接続情報を設定してください：

```
NEXT_PUBLIC_SUPABASE_URL=your-supabase-url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-supabase-anon-key
```

### 3.  ローカル開発環境の起動
このプロジェクトは、データベースの構造をコードで管理するためにSupabaseのマイグレーション機能を利用しています。以下のコマンドを実行するだけで、必要なテーブルが全てセットアップされたローカル開発環境が起動します。

**前提:**
- [Supabase CLI](https://supabase.com/docs/guides/cli)がインストールされていること。
- [Docker](https://www.docker.com/)が起動していること。

**手順:**
1. Supabaseの各種サービス（DB、Authなど）をローカルで起動します。
   ```bash
   supabase start
   ```
2. アプリケーションの開発サーバーを起動します。
   ```bash
   pnpm run dev
   ```

アプリケーションは [http://localhost:3000](http://localhost:3000) で、ローカルのSupabase Studio（DB管理画面）は `supabase start` 実行時にターミナルに表示されるURL（通常は `http://localhost:54323`）でアクセスできます。

## データベース開発ルール

本プロジェクトでは、データベースのスキーマ（テーブル定義など）への全ての変更を、Supabaseのマイグレーション機能を用いて管理します。**Supabase管理画面のSQL Editorを直接編集することは原則禁止です。**

### スキーマ変更の基本フロー

データベースのテーブル定義等を変更する場合は、必ず以下の手順に従ってください。

1.  **マイグレーションファイルの作成:**
    変更内容を示す分かりやすい名前で、新しいマイグレーションファイルを作成します。
    ```bash
    # 例: staffテーブルに memo カラムを追加する場合
    supabase migration new add_memo_to_staff_table
    ```

2.  **SQLの記述:**
    `supabase/migrations/` ディレクトリに生成されたSQLファイルを開き、変更内容のSQL（例: `ALTER TABLE ... ADD COLUMN ...`）を記述します。

3.  **ローカルでの動作確認（必須）:**
    ローカルデータベースを一度リセットし、全てのマイグレーションがエラーなく正しく適用されることを確認します。
    ```bash
    supabase db reset
    ```
    その後、ローカルのSupabase Studio (`http://localhost:54323`) で、意図した通りにテーブル構造が変更されているかを目視で確認してください。

4.  **Gitへのコミット:**
    安全性が確認できたマイグレーションファイルをGitにコミットし、pushします。
    ```bash
    git add supabase/migrations/
    git commit -m "feat: Add memo column to staff table"
    git push
    ```

5.  **本番環境への適用:**
    mainブランチにマージされた後、以下のコマンドで本番データベースに変更を安全に適用します。このコマンドは、未適用のマイグレーションのみを実行します。
    ```bash
    supabase db push
    ```

アプリケーションは [http://localhost:3000](http://localhost:3000) でアクセスできます。

## データベース構造

### テーブル構成
- `users` - 利用者マスタ
- `consultations` - 相談テーブル
- `support_plans` - 支援計画テーブル
- `staff` - スタッフテーブル

### 主要な機能
- Row Level Security (RLS) による安全なデータアクセス
- 自動的な作成・更新日時の記録
- UUID による主キー設定
- consultationsテーブルにstatusカラムを追加し、相談の進捗状況を管理
## 使用方法

### 利用者登録
1. サイドバーの「新規利用者追加」ボタンをクリック
2. 必要情報を入力（氏名は必須）
3. システムが自動でUIDを採番

### 相談受付
1. ヘッダーの「新規相談」をクリック
2. 匿名相談の場合は氏名を空欄に
3. 詳細な相談内容を入力して保存

### 相談の進捗管理
1. 「相談履歴」ページを開く
2. 各相談記録の行にあるドロップダウンリストから、新しいステータス（例：「物件探し中」）を選択
3. ページ上部のフィルタボタンを使い、「支援終了」や「利用者登録済み」などの条件で相談を絞り込む

### 支援計画作成
1. 相談履歴から「利用者として登録」を実行
2. 支援計画フォームで詳細情報を入力
3. 更新履歴は自動で保存

### データ管理
1. 「データ管理」ページでインポート・エクスポートを実行
2. 期間を指定して相談実績レポートを生成
3. Excel/CSV形式でのデータ出力

## 非機能要件

### セキュリティ
- Supabase Row Level Security による適切なアクセス制御
- 個人情報の適切な保護
- 一般的なWebアプリケーション脆弱性対策

### パフォーマンス
- 100名以上の利用者に対応
- 効率的なデータベースインデックス
- 遅延のないスムーズな操作

### UI/UX
- 直感的で一貫性のあるデザイン
- ITに不慣れなユーザーでも操作可能
- レスポンシブデザイン（PC・タブレット対応）

### 保守性
- モジュール化されたコード構造
- TypeScriptによる型安全性
- 将来の機能追加・改修が容易

## 今後の拡張予定

- 利用者別の支援計画履歴表示
- より詳細なレポート機能
- スタッフ権限管理
- 通知機能
- モバイルアプリ対応

## ライセンス

このプロジェクトは社会福祉法人向けに開発されました。
